name: Test Poosh Action

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

jobs:
  # 1. Test: Successful push (push event)
  push-success:
    name: Push Success (push event)
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - name: Make a change
        run: echo "test $(date)" >> poosh-testfile.txt
      - name: Poosh (push)
        id: poosh
        uses: ./
        with:
          commit-message: "test: push success"
          branch: "test-push"
      - name: Assert outputs
        run: |
          if [ -n "${{ steps.poosh.outputs.branch }}" ] && [ -n "${{ steps.poosh.outputs.commit-sha }}" ]; then
            echo "Branch: ${{ steps.poosh.outputs.branch }}"
            echo "Commit SHA: ${{ steps.poosh.outputs.commit-sha }}"
            exit 0
          else
            echo "No commit or push occurred, outputs are empty as expected."
            exit 0
          fi

  # 2. Test: Successful PR (pull_request event)
  pr-success:
    name: PR Success (pull_request event)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - name: Make a change
        run: echo "test $(date)" >> poosh-testfile.txt
      - name: Poosh (PR)
        id: poosh
        uses: ./
        with:
          commit-message: "test: pr success"
          branch: "test-pr"
          trigger-pr-number: ${{ github.event.pull_request.number }}
          trigger-branch-name: ${{ github.head_ref || github.ref_name }}
      - name: Assert outputs
        run: |
          if [ -n "${{ steps.poosh.outputs.branch }}" ] && [ -n "${{ steps.poosh.outputs.commit-sha }}" ] && [ -n "${{ steps.poosh.outputs.pr-url }}" ] && [ -n "${{ steps.poosh.outputs.pr-number }}" ]; then
            echo "Branch: ${{ steps.poosh.outputs.branch }}"
            echo "Commit SHA: ${{ steps.poosh.outputs.commit-sha }}"
            echo "PR URL: ${{ steps.poosh.outputs.pr-url }}"
            echo "PR Number: ${{ steps.poosh.outputs.pr-number }}"
            exit 0
          else
            echo "No PR was created, outputs are empty as expected."
            exit 0
          fi

  # 3. Test: Validation error (missing commit-message)
  error-missing-commit-message:
    name: Error - Missing Commit Message
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Poosh (missing commit-message)
        id: poosh
        continue-on-error: true
        run: |
          echo "Expected error: ERROR: 'commit-message' is required and must be a non-empty string."
          $GITHUB_ACTION_PATH 2>&1 | tee poosh-missing-commit-message.log
          echo "::endgroup::"
      - name: Show expected and actual error messages for missing commit-message
        if: always()
        run: |
          echo "EXPECTED ERROR MESSAGE:"
          echo "ERROR: 'commit-message' is required and must be a non-empty string."
          echo ""
          echo "ACTUAL ERROR MESSAGE:"
          cat poosh-missing-commit-message.log

  # 4. Test: Validation error (invalid branch)
  error-invalid-branch:
    name: Error - Invalid Branch
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Poosh (invalid branch)
        id: poosh
        continue-on-error: true
        run: |
          echo "Expected error: ERROR: 'branch' contains invalid characters. Only alphanumeric, '.', '_', '-', and '/' are allowed."
          $GITHUB_ACTION_PATH 2>&1 | tee poosh-invalid-branch.log
          echo "::endgroup::"
      - name: Show expected and actual error messages for invalid branch
        if: always()
        run: |
          echo "EXPECTED ERROR MESSAGE:"
          echo "ERROR: 'branch' contains invalid characters. Only alphanumeric, '.', '_', '-', and '/' are allowed."
          echo ""
          echo "ACTUAL ERROR MESSAGE:"
          cat poosh-invalid-branch.log

  # 5. Test: Warning for missing triggers
  warning-missing-triggers:
    name: Warning - Missing Triggers
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Make a change
        run: echo "test $(date)" >> poosh-testfile.txt
      - name: Poosh (missing triggers)
        id: poosh
        uses: ./
        with:
          commit-message: "test: warning missing triggers"
          branch: "test-warning"
      - name: Assert outputs
        run: |
          if [ -n "${{ steps.poosh.outputs.branch }}" ] && [ -n "${{ steps.poosh.outputs.commit-sha }}" ]; then
            echo "Branch: ${{ steps.poosh.outputs.branch }}"
            echo "Commit SHA: ${{ steps.poosh.outputs.commit-sha }}"
            exit 0
          else
            echo "No commit or push occurred, outputs are empty as expected."
            exit 0
          fi

  # 6. Test: No changes (should not push or PR)
  no-changes:
    name: No Changes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Poosh (no changes)
        id: poosh
        uses: ./
        with:
          commit-message: "test: no changes"
          branch: "test-no-changes"
      - name: Assert outputs
        run: |
          if [ -n "${{ steps.poosh.outputs.branch }}" ] && [ -n "${{ steps.poosh.outputs.commit-sha }}" ]; then
            echo "Branch: ${{ steps.poosh.outputs.branch }}"
            echo "Commit SHA: ${{ steps.poosh.outputs.commit-sha }}"
            exit 0
          else
            echo "No commit or push occurred, outputs are empty as expected."
            exit 0
          fi

  # 7. Test: Custom PR body (with triggers)
  custom-pr-body-with-triggers:
    name: Custom PR Body (with triggers)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Make a change
        run: echo "test $(date)" >> poosh-testfile.txt
      - name: Poosh (custom PR body with triggers)
        id: poosh
        uses: ./
        with:
          commit-message: "test: custom pr body with triggers"
          branch: "test-custom-pr-body-triggers"
          pr-body: |
            This PR is a custom test for Poosh.
            Triggered by workflow_dispatch.
          trigger-pr-number: 1234
          trigger-branch-name: "feature/test"
      - name: Assert outputs
        run: |
          if [ -n "${{ steps.poosh.outputs.branch }}" ] && [ -n "${{ steps.poosh.outputs.commit-sha }}" ] && [ -n "${{ steps.poosh.outputs.pr-url }}" ] && [ -n "${{ steps.poosh.outputs.pr-number }}" ]; then
            echo "Branch: ${{ steps.poosh.outputs.branch }}"
            echo "Commit SHA: ${{ steps.poosh.outputs.commit-sha }}"
            echo "PR URL: ${{ steps.poosh.outputs.pr-url }}"
            echo "PR Number: ${{ steps.poosh.outputs.pr-number }}"
            exit 0
          else
            echo "No PR was created, outputs are empty as expected."
            exit 0
          fi

  # 8. Test: Custom PR body (without triggers)
  custom-pr-body-no-triggers:
    name: Custom PR Body (no triggers)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Make a change
        run: echo "test $(date)" >> poosh-testfile.txt
      - name: Poosh (custom PR body no triggers)
        id: poosh
        uses: ./
        with:
          commit-message: "test: custom pr body no triggers"
          branch: "test-custom-pr-body-no-triggers"
          pr-body: |
            This PR is a custom test for Poosh.
            No triggers provided.
      - name: Assert outputs
        run: |
          if [ -n "${{ steps.poosh.outputs.branch }}" ] && [ -n "${{ steps.poosh.outputs.commit-sha }}" ] && [ -n "${{ steps.poosh.outputs.pr-url }}" ] && [ -n "${{ steps.poosh.outputs.pr-number }}" ]; then
            echo "Branch: ${{ steps.poosh.outputs.branch }}"
            echo "Commit SHA: ${{ steps.poosh.outputs.commit-sha }}"
            echo "PR URL: ${{ steps.poosh.outputs.pr-url }}"
            echo "PR Number: ${{ steps.poosh.outputs.pr-number }}"
            exit 0
          else
            echo "No PR was created, outputs are empty as expected."
            exit 0
          fi

  # 9. Test: Branch already exists with changes (should update branch)
  branch-exists-with-changes:
    name: Branch Exists With Changes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set git user identity for test
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
      - name: Create branch and push initial commit
        run: |
          git checkout -b poosh/existing-branch
          echo "initial" > poosh-existing.txt
          git add poosh-existing.txt
          git commit -m "initial commit"
          git push origin poosh/existing-branch
      - name: Make a new change
        run: echo "update $(date)" >> poosh-existing.txt
      - name: Poosh (update existing branch)
        id: poosh
        uses: ./
        with:
          commit-message: "test: update existing branch"
          branch: "existing-branch"
      - name: Assert outputs
        run: |
          if [ -n "${{ steps.poosh.outputs.branch }}" ] && [ -n "${{ steps.poosh.outputs.commit-sha }}" ]; then
            echo "Branch: ${{ steps.poosh.outputs.branch }}"
            echo "Commit SHA: ${{ steps.poosh.outputs.commit-sha }}"
            exit 0
          else
            echo "No commit or push occurred, outputs are empty as expected."
            exit 0
          fi

  # 10. Test: Branch already exists with no changes (should not commit)
  branch-exists-no-changes:
    name: Branch Exists No Changes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set git user identity for test
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
      - name: Create branch and push initial commit
        run: |
          git checkout -b poosh/existing-nochange
          echo "initial" > poosh-existing-nochange.txt
          git add poosh-existing-nochange.txt
          git commit -m "initial commit"
          git push origin poosh/existing-nochange
      - name: Poosh (no changes on existing branch)
        id: poosh
        uses: ./
        with:
          commit-message: "test: no changes on existing branch"
          branch: "existing-nochange"
      - name: Assert outputs
        run: |
          if [ -n "${{ steps.poosh.outputs.branch }}" ] && [ -n "${{ steps.poosh.outputs.commit-sha }}" ]; then
            echo "Branch: ${{ steps.poosh.outputs.branch }}"
            echo "Commit SHA: ${{ steps.poosh.outputs.commit-sha }}"
            exit 0
          else
            echo "No commit or push occurred, outputs are empty as expected."
            exit 0
          fi

  # 11. Test: Branch was deleted remotely (should handle gracefully and recreate if needed)
  branch-deleted-remotely:
    name: Branch Deleted Remotely
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set git user identity for test
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
      - name: Create and push branch, then delete remotely
        run: |
          git checkout -b poosh/deleted-remote
          echo "initial" > poosh-deleted-remote.txt
          git add poosh-deleted-remote.txt
          git commit -m "initial commit"
          git push origin poosh/deleted-remote
          git push origin --delete poosh/deleted-remote
      - name: Make a new change
        run: echo "update $(date)" >> poosh-deleted-remote.txt
      - name: Poosh (recreate deleted branch)
        id: poosh
        uses: ./
        with:
          commit-message: "test: recreate deleted branch"
          branch: "deleted-remote"
      - name: Assert outputs
        run: |
          if [ -n "${{ steps.poosh.outputs.branch }}" ] && [ -n "${{ steps.poosh.outputs.commit-sha }}" ]; then
            echo "Branch: ${{ steps.poosh.outputs.branch }}"
            echo "Commit SHA: ${{ steps.poosh.outputs.commit-sha }}"
            exit 0
          else
            echo "No commit or push occurred, outputs are empty as expected."
            exit 0
          fi

  # 12. Test: PR already exists for the branch (should update PR, not create duplicate)
  pr-already-exists:
    name: PR Already Exists For Branch
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set git user identity for test
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
      - name: Create branch and open PR
        run: |
          git checkout -b poosh/pr-exists
          echo "initial" > poosh-pr-exists.txt
          git add poosh-pr-exists.txt
          git commit -m "initial commit"
          git push origin poosh/pr-exists
          # Open PR using GitHub CLI
          gh pr create --base master --head poosh/pr-exists --title "Poosh PR Exists" --body "Initial PR"
        env:
          GH_TOKEN: ${{ github.token }}
      - name: Make a new change
        run: echo "update $(date)" >> poosh-pr-exists.txt
      - name: Poosh (update existing PR)
        id: poosh
        uses: ./
        with:
          commit-message: "test: update existing PR"
          branch: "pr-exists"
      - name: Assert outputs
        run: |
          if [ -n "${{ steps.poosh.outputs.branch }}" ] && [ -n "${{ steps.poosh.outputs.commit-sha }}" ] && [ -n "${{ steps.poosh.outputs.pr-url }}" ] && [ -n "${{ steps.poosh.outputs.pr-number }}" ]; then
            echo "Branch: ${{ steps.poosh.outputs.branch }}"
            echo "Commit SHA: ${{ steps.poosh.outputs.commit-sha }}"
            echo "PR URL: ${{ steps.poosh.outputs.pr-url }}"
            echo "PR Number: ${{ steps.poosh.outputs.pr-number }}"
            exit 0
          else
            echo "No PR was created, outputs are empty as expected."
            exit 0
          fi

  # 13. Test: PR closed without merge (should allow re-opening or new PR)
  pr-closed-no-merge:
    name: PR Closed Without Merge
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set git user identity for test
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
      - name: Create branch and open PR, then close PR
        run: |
          git checkout -b poosh/pr-closed
          echo "initial" > poosh-pr-closed.txt
          git add poosh-pr-closed.txt
          git commit -m "initial commit"
          git push origin poosh/pr-closed
          gh pr create --base master --head poosh/pr-closed --title "Poosh PR Closed" --body "Initial PR"
          PR_NUMBER=$(gh pr list --head poosh/pr-closed --json number -q '.[0].number')
          gh pr close "$PR_NUMBER"
        env:
          GH_TOKEN: ${{ github.token }}
      - name: Make a new change
        run: echo "update $(date)" >> poosh-pr-closed.txt
      - name: Poosh (reopen or new PR)
        id: poosh
        uses: ./
        with:
          commit-message: "test: reopen or new PR"
          branch: "pr-closed"
      - name: Assert outputs
        run: |
          if [ -n "${{ steps.poosh.outputs.branch }}" ] && [ -n "${{ steps.poosh.outputs.commit-sha }}" ] && [ -n "${{ steps.poosh.outputs.pr-url }}" ] && [ -n "${{ steps.poosh.outputs.pr-number }}" ]; then
            echo "Branch: ${{ steps.poosh.outputs.branch }}"
            echo "Commit SHA: ${{ steps.poosh.outputs.commit-sha }}"
            echo "PR URL: ${{ steps.poosh.outputs.pr-url }}"
            echo "PR Number: ${{ steps.poosh.outputs.pr-number }}"
            exit 0
          else
            echo "No PR was created, outputs are empty as expected."
            exit 0
          fi

  # 14. Test: PR merged and branch deleted (should recreate branch if needed)
  pr-merged-branch-deleted:
    name: PR Merged and Branch Deleted
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set git user identity for test
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
      - name: Create branch and open PR, then merge and delete branch
        run: |
          git checkout -b poosh/pr-merged
          echo "initial" > poosh-pr-merged.txt
          git add poosh-pr-merged.txt
          git commit -m "initial commit"
          git push origin poosh/pr-merged
          gh pr create --base master --head poosh/pr-merged --title "Poosh PR Merged" --body "Initial PR"
          PR_NUMBER=$(gh pr list --head poosh/pr-merged --json number -q '.[0].number')
          gh pr merge "$PR_NUMBER" --merge
          git push origin --delete poosh/pr-merged
        env:
          GH_TOKEN: ${{ github.token }}
      - name: Make a new change
        run: echo "update $(date)" >> poosh-pr-merged.txt
      - name: Poosh (recreate branch after merge)
        id: poosh
        uses: ./
        with:
          commit-message: "test: recreate branch after merge"
          branch: "pr-merged"
      - name: Assert outputs
        run: |
          if [ -n "${{ steps.poosh.outputs.branch }}" ] && [ -n "${{ steps.poosh.outputs.commit-sha }}" ]; then
            echo "Branch: ${{ steps.poosh.outputs.branch }}"
            echo "Commit SHA: ${{ steps.poosh.outputs.commit-sha }}"
            exit 0
          else
            echo "No commit or push occurred, outputs are empty as expected."
            exit 0
          fi

  # 15. Test: Action run with no git user config (should set it automatically)
  no-git-user-config:
    name: No Git User Config
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Unset git user config
        run: |
          git config --unset --global user.name || true
          git config --unset --global user.email || true
      - name: Make a change
        run: echo "test $(date)" >> poosh-nouser.txt
      - name: Poosh (no git user config)
        id: poosh
        uses: ./
        with:
          commit-message: "test: no git user config"
          branch: "no-git-user"
      - name: Assert outputs
        run: |
          if [ -n "${{ steps.poosh.outputs.branch }}" ] && [ -n "${{ steps.poosh.outputs.commit-sha }}" ]; then
            echo "Branch: ${{ steps.poosh.outputs.branch }}"
            echo "Commit SHA: ${{ steps.poosh.outputs.commit-sha }}"
            exit 0
          else
            echo "No commit or push occurred, outputs are empty as expected."
            exit 0
          fi

  # 16. Test: Action run in a detached HEAD state (should handle gracefully)
  detached-head:
    name: Detached HEAD State
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: master
      - name: Detach HEAD
        run: |
          git checkout --detach
      - name: Make a change
        run: echo "test $(date)" >> poosh-detached.txt
      - name: Poosh (detached HEAD)
        id: poosh
        uses: ./
        with:
          commit-message: "test: detached HEAD"
          branch: "detached-head"
      - name: Assert outputs
        run: |
          if [ -n "${{ steps.poosh.outputs.branch }}" ] && [ -n "${{ steps.poosh.outputs.commit-sha }}" ]; then
            echo "Branch: ${{ steps.poosh.outputs.branch }}"
            echo "Commit SHA: ${{ steps.poosh.outputs.commit-sha }}"
            exit 0
          else
            echo "No commit or push occurred, outputs are empty as expected."
            exit 0
          fi

  # 17. Test: Only untracked files (should not commit)
  only-untracked-files:
    name: Only Untracked Files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Create untracked file
        run: echo "untracked" > poosh-untracked.txt
      - name: Poosh (only untracked files)
        id: poosh
        uses: ./
        with:
          commit-message: "test: only untracked files"
          branch: "only-untracked"
      - name: Assert outputs
        run: |
          if [ -n "${{ steps.poosh.outputs.branch }}" ] && [ -n "${{ steps.poosh.outputs.commit-sha }}" ]; then
            echo "Branch: ${{ steps.poosh.outputs.branch }}"
            echo "Commit SHA: ${{ steps.poosh.outputs.commit-sha }}"
            exit 0
          else
            echo "No commit or push occurred, outputs are empty as expected."
            exit 0
          fi

  # 18. Test: Staged but uncommitted changes before action runs (should commit all changes)
  staged-uncommitted-changes:
    name: Staged But Uncommitted Changes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Stage changes
        run: |
          echo "staged change" > poosh-staged.txt
          git add poosh-staged.txt
      - name: Poosh (staged but uncommitted)
        id: poosh
        uses: ./
        with:
          commit-message: "test: staged but uncommitted"
          branch: "staged-uncommitted"
      - name: Assert outputs
        run: |
          if [ -n "${{ steps.poosh.outputs.branch }}" ] && [ -n "${{ steps.poosh.outputs.commit-sha }}" ]; then
            echo "Branch: ${{ steps.poosh.outputs.branch }}"
            echo "Commit SHA: ${{ steps.poosh.outputs.commit-sha }}"
            exit 0
          else
            echo "No commit or push occurred, outputs are empty as expected."
            exit 0
          fi

  # 19. Test: Branch name collision with existing non-poosh branch (should not overwrite)
  branch-name-collision:
    name: Branch Name Collision With Non-Poosh Branch
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set git user identity for test
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
      - name: Create non-poosh branch
        run: |
          git checkout -b collision-branch
          echo "collision" > poosh-collision.txt
          git add poosh-collision.txt
          git commit -m "collision branch"
          git push origin collision-branch
      - name: Poosh (branch name collision)
        id: poosh
        uses: ./
        with:
          commit-message: "test: branch name collision"
          branch: "collision-branch"
      - name: Assert outputs
        run: |
          # Should not overwrite non-poosh branch, so outputs should be empty
          if [ -n "${{ steps.poosh.outputs.branch }}" ] && [ -n "${{ steps.poosh.outputs.commit-sha }}" ]; then
            echo "Branch: ${{ steps.poosh.outputs.branch }}"
            echo "Commit SHA: ${{ steps.poosh.outputs.commit-sha }}"
            exit 1
          else
            echo "No commit or push occurred, outputs are empty as expected."
            exit 0
          fi

  # 20. Test: Invalid input combinations (both triggers missing, should warn but not error)
  missing-triggers-warning:
    name: Missing Triggers Warning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Make a change
        run: echo "test $(date)" >> poosh-missing-triggers.txt
      - name: Poosh (missing triggers warning)
        id: poosh
        uses: ./
        with:
          commit-message: "test: missing triggers warning"
          branch: "missing-triggers-warning"
      - name: Assert outputs
        run: |
          if [ -n "${{ steps.poosh.outputs.branch }}" ] && [ -n "${{ steps.poosh.outputs.commit-sha }}" ]; then
            echo "Branch: ${{ steps.poosh.outputs.branch }}"
            echo "Commit SHA: ${{ steps.poosh.outputs.commit-sha }}"
            exit 0
          else
            echo "No commit or push occurred, outputs are empty as expected."
            exit 0
          fi
